import{r as i,j as e,F as ee,E as r}from"./index-DSsuIlLv.js";import{d as R,M as O}from"./Modal-DgMyIizJ.js";import{B as D,D as ae,C as se,e as te,b as le,c as ne,p as ie,d as de,A as re}from"./index-Dr-rV247.js";se.register(te,le,ne,ie,de,re);function me(){const[h,F]=i.useState(R().format("YYYY-MM")),[j,Y]=i.useState([]),[ce,A]=i.useState([]),[l,o]=i.useState(null),[s,P]=i.useState(null),[u,T]=i.useState(R().format("YYYY-MM")),[q,C]=i.useState([]),[M,f]=i.useState(""),[b,w]=i.useState("bothEqualsOne"),[g,I]=i.useState(""),[v,$]=i.useState("spent"),[N,W]=i.useState(10);async function S(){const{data:a}=await r.get("/admin/overview",{params:{month:h}});Y(a.users),f(a.settings.mealCost),w(a.settings.countingRule)}i.useEffect(()=>{S()},[h]);async function H(){await r.patch("/admin/settings",{mealCost:Number(M),countingRule:b}),S()}async function k(){const{data:a}=await r.get("/admin/users");A(a)}i.useEffect(()=>{k()},[]);function y(){o(null)}async function Q(){await r.patch(`/admin/users/${l._id||l.id}`,{name:l.name,email:l.email,role:l.role,balance:l.balance,phone:l.phone,photoUrl:l.photoUrl}),y(),k()}function z(){P(null),C([])}async function m(a,t){const{data:n}=await r.get("/admin/meals",{params:{userId:a,month:t}});C(n.logs||[])}async function E(a,t,n,d){await r.post("/admin/meals/upsert",{userId:a,date:t,[n]:d}),await m(a,u)}function G(a){const t=!!a?.breakfast,n=!!a?.dinner;if(typeof a?.overrideCount=="number")return Number(a.overrideCount);switch(b){case"perMeal":return(t?1:0)+(n?1:0);case"perMealHalf":return(t?.5:0)+(n?.5:0);case"anyMealIsOne":return t||n?1:0;case"bothEqualsOne":default:return t&&n?1:0}}async function p(a,t,n){const d=Number(G(t)||0),B=Math.max(0,Math.round((d+n)*100)/100);await r.post("/admin/meals/upsert",{userId:a,date:t.date,overrideCount:B}),await m(a,u)}async function J(){try{const a=await r.get("/admin/pdf",{params:{month:h},responseType:"blob"}),t=new Blob([a.data],{type:"application/pdf"}),n=URL.createObjectURL(t),d=document.createElement("a");d.href=n,d.download=`mess-overview-${h}.pdf`,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(n)}catch(a){alert(a?.response?.data?.error||"Failed to download PDF")}}const c=i.useMemo(()=>{const a=v,t=j.filter(n=>(n.name+" "+n.email).toLowerCase().includes(g.toLowerCase()));return t.sort((n,d)=>{const L={meals:"totalMeals",spent:"totalCost",balance:"balance"}[a];return(d[L]||0)-(n[L]||0)}),t.slice(0,N)},[j,g,v,N]),x=c.map(a=>a.name),K=c.map(a=>a.totalMeals),U=c.map(a=>Math.round(a.totalCost));c.map(a=>Math.round(a.balance));const _={responsive:!0,plugins:{legend:{display:!0}}},V={labels:x,datasets:[{label:"Meals",data:K,backgroundColor:"#0F766E"}]},X={labels:x,datasets:[{label:"Spent (৳)",data:U,backgroundColor:"#B77466"}]},Z={labels:x,datasets:[{data:U,backgroundColor:x.map((a,t)=>`hsl(${t*37%360} 70% 65%)`)}]};return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card glass",children:[e.jsx("h2",{children:"Admin Overview"}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:h,onChange:a=>F(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Meal Cost"}),e.jsx("input",{className:"input",type:"number",value:M,onChange:a=>f(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Counting Rule"}),e.jsxs("select",{className:"input",value:b,onChange:a=>w(a.target.value),children:[e.jsx("option",{value:"bothEqualsOne",children:"Both meals = 1"}),e.jsx("option",{value:"anyMealIsOne",children:"Any meal = 1"}),e.jsx("option",{value:"perMeal",children:"Per meal (1.0 each)"}),e.jsx("option",{value:"perMealHalf",children:"Per meal (0.5 each)"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"end",gap:8},children:[e.jsx("button",{className:"btn",onClick:H,children:"Save"}),e.jsx("button",{className:"btn",onClick:J,children:"PDF"})]})]})]}),e.jsxs("div",{className:"card glass",style:{marginTop:16},children:[e.jsxs("h3",{style:{marginTop:0},children:[e.jsx(ee,{})," Analytics"]}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Search"}),e.jsx("input",{className:"input",placeholder:"name or email",value:g,onChange:a=>I(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Sort By"}),e.jsxs("select",{className:"input",value:v,onChange:a=>$(a.target.value),children:[e.jsx("option",{value:"spent",children:"Spent"}),e.jsx("option",{value:"meals",children:"Meals"}),e.jsx("option",{value:"balance",children:"Balance"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Top N"}),e.jsx("input",{className:"input",type:"number",min:"1",max:"50",value:N,onChange:a=>W(parseInt(a.target.value||"1",10))})]})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:12},children:e.jsxs("div",{className:"grid cols-2",style:{minWidth:640},children:[e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Meals by User"}),c.length?e.jsx(D,{options:_,data:V}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend by User"}),c.length?e.jsx(D,{options:_,data:X}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend Share"}),c.length?e.jsx(ae,{data:Z}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Leaderboard"}),e.jsx("ol",{style:{margin:0,paddingLeft:18},children:c.map((a,t)=>e.jsxs("li",{style:{marginBottom:6},children:[a.name," — ৳",Math.round(a.totalCost)," • ",a.totalMeals," meals"]},a.id))})]})]})})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:16},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Meals"}),e.jsx("th",{children:"Meal Cost"}),e.jsx("th",{children:"Spent"}),e.jsx("th",{children:"Balance"})]})}),e.jsx("tbody",{children:j.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.totalMeals}),e.jsx("td",{children:a.mealCost}),e.jsx("td",{children:a.totalCost}),e.jsx("td",{children:a.balance})]},a.id))})]})}),e.jsx(O,{open:!!l,onClose:y,title:"Edit User",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:y,children:"Cancel"}),e.jsx("button",{className:"btn teal",onClick:Q,children:"Save"})]}),children:l&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:l.name||"",onChange:a=>o({...l,name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:l.email||"",onChange:a=>o({...l,email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:l.role||"user",onChange:a=>o({...l,role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:l.balance||0,onChange:a=>o({...l,balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Phone"}),e.jsx("input",{className:"input",value:l.phone||"",onChange:a=>o({...l,phone:a.target.value})}),e.jsx("label",{className:"label",children:"Photo URL"}),e.jsx("input",{className:"input",value:l.photoUrl||"",onChange:a=>o({...l,photoUrl:a.target.value})})]})}),e.jsx(O,{open:!!s,onClose:z,title:s?`Meals: ${s.name}`:"Meals",children:s&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:u,onChange:async a=>{T(a.target.value),await m(s._id||s.id,a.target.value)}}),e.jsx("div",{className:"scroll-x",children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"}),e.jsx("th",{children:"Override (meals)"}),e.jsx("th",{children:"Adjust"})]})}),e.jsx("tbody",{children:q.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:t=>E(s._id||s.id,a.date,"breakfast",t.target.checked)})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:t=>E(s._id||s.id,a.date,"dinner",t.target.checked)})}),e.jsx("td",{children:e.jsx("input",{className:"input",style:{maxWidth:100},type:"number",step:"0.01",placeholder:"auto",value:a.overrideCount??"",onChange:async t=>{const n=t.target.value;await r.post("/admin/meals/upsert",{userId:s._id||s.id,date:a.date,overrideCount:n===""?"":Number(n)}),await m(s._id||s.id,u)}})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn",onClick:()=>p(s._id||s.id,a,-1),children:"-1"}),e.jsx("button",{className:"btn",onClick:()=>p(s._id||s.id,a,-.5),children:"-0.5"}),e.jsx("button",{className:"btn",onClick:()=>p(s._id||s.id,a,.5),children:"+0.5"}),e.jsx("button",{className:"btn",onClick:()=>p(s._id||s.id,a,1),children:"+1"}),e.jsx("button",{className:"btn",onClick:async()=>{await r.post("/admin/meals/upsert",{userId:s._id||s.id,date:a.date,overrideCount:""}),await m(s._id||s.id,u)},children:"Clear"})]})})]},a._id||a.date))})]})})]})})]})}export{me as default};
