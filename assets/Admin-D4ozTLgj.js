import{r as t,j as e,F as V,E as o}from"./index-LIAtnsiq.js";import{d as L,M as R}from"./Modal-BQ2GDFM9.js";import{B as D,D as X,C as Z,e as ee,b as ae,c as se,p as le,d as te,A as ne}from"./index-C9RJkj3k.js";Z.register(ee,ae,se,le,te,ne);function he(){const[h,F]=t.useState(L().format("YYYY-MM")),[u,Y]=t.useState([]),[ie,_]=t.useState([]),[s,r]=t.useState(null),[i,O]=t.useState(null),[b,P]=t.useState(L().format("YYYY-MM")),[T,v]=t.useState([]),[N,y]=t.useState(""),[C,M]=t.useState("bothEqualsOne"),[p,A]=t.useState(""),[x,$]=t.useState("spent"),[j,q]=t.useState(10);async function f(){const{data:a}=await o.get("/admin/overview",{params:{month:h}});Y(a.users),y(a.settings.mealCost),M(a.settings.countingRule)}t.useEffect(()=>{f()},[h]);async function I(){await o.patch("/admin/settings",{mealCost:Number(N),countingRule:C}),f()}async function S(){const{data:a}=await o.get("/admin/users");_(a)}t.useEffect(()=>{S()},[]);function g(){r(null)}async function H(){await o.patch(`/admin/users/${s._id||s.id}`,{name:s.name,email:s.email,role:s.role,balance:s.balance,phone:s.phone,photoUrl:s.photoUrl}),g(),S()}function Q(){O(null),v([])}async function w(a,l){const{data:n}=await o.get("/admin/meals",{params:{userId:a,month:l}});v(n.logs||[])}async function E(a,l,n,c){await o.post("/admin/meals/upsert",{userId:a,date:l,[n]:c}),await w(a,b)}async function W(){try{const a=await o.get("/admin/pdf",{params:{month:h},responseType:"blob"}),l=new Blob([a.data],{type:"application/pdf"}),n=URL.createObjectURL(l),c=document.createElement("a");c.href=n,c.download=`mess-overview-${h}.pdf`,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(n)}catch(a){alert(a?.response?.data?.error||"Failed to download PDF")}}const d=t.useMemo(()=>{const a=x,l=u.filter(n=>(n.name+" "+n.email).toLowerCase().includes(p.toLowerCase()));return l.sort((n,c)=>{const B={meals:"totalMeals",spent:"totalCost",balance:"balance"}[a];return(c[B]||0)-(n[B]||0)}),l.slice(0,j)},[u,p,x,j]),m=d.map(a=>a.name),z=d.map(a=>a.totalMeals),U=d.map(a=>Math.round(a.totalCost));d.map(a=>Math.round(a.balance));const k={responsive:!0,plugins:{legend:{display:!0}}},G={labels:m,datasets:[{label:"Meals",data:z,backgroundColor:"#0F766E"}]},J={labels:m,datasets:[{label:"Spent (৳)",data:U,backgroundColor:"#B77466"}]},K={labels:m,datasets:[{data:U,backgroundColor:m.map((a,l)=>`hsl(${l*37%360} 70% 65%)`)}]};return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card glass",children:[e.jsx("h2",{children:"Admin Overview"}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:h,onChange:a=>F(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Meal Cost"}),e.jsx("input",{className:"input",type:"number",value:N,onChange:a=>y(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Counting Rule"}),e.jsxs("select",{className:"input",value:C,onChange:a=>M(a.target.value),children:[e.jsx("option",{value:"bothEqualsOne",children:"Both meals = 1"}),e.jsx("option",{value:"anyMealIsOne",children:"Any meal = 1"}),e.jsx("option",{value:"perMeal",children:"Per meal (1.0 each)"}),e.jsx("option",{value:"perMealHalf",children:"Per meal (0.5 each)"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"end",gap:8},children:[e.jsx("button",{className:"btn",onClick:I,children:"Save"}),e.jsx("button",{className:"btn",onClick:W,children:"PDF"})]})]})]}),e.jsxs("div",{className:"card glass",style:{marginTop:16},children:[e.jsxs("h3",{style:{marginTop:0},children:[e.jsx(V,{})," Analytics"]}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Search"}),e.jsx("input",{className:"input",placeholder:"name or email",value:p,onChange:a=>A(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Sort By"}),e.jsxs("select",{className:"input",value:x,onChange:a=>$(a.target.value),children:[e.jsx("option",{value:"spent",children:"Spent"}),e.jsx("option",{value:"meals",children:"Meals"}),e.jsx("option",{value:"balance",children:"Balance"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Top N"}),e.jsx("input",{className:"input",type:"number",min:"1",max:"50",value:j,onChange:a=>q(parseInt(a.target.value||"1",10))})]})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:12},children:e.jsxs("div",{className:"grid cols-2",style:{minWidth:640},children:[e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Meals by User"}),d.length?e.jsx(D,{options:k,data:G}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend by User"}),d.length?e.jsx(D,{options:k,data:J}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend Share"}),d.length?e.jsx(X,{data:K}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Leaderboard"}),e.jsx("ol",{style:{margin:0,paddingLeft:18},children:d.map((a,l)=>e.jsxs("li",{style:{marginBottom:6},children:[a.name," — ৳",Math.round(a.totalCost)," • ",a.totalMeals," meals"]},a.id))})]})]})})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:16},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Meals"}),e.jsx("th",{children:"Meal Cost"}),e.jsx("th",{children:"Spent"}),e.jsx("th",{children:"Balance"})]})}),e.jsx("tbody",{children:u.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.totalMeals}),e.jsx("td",{children:a.mealCost}),e.jsx("td",{children:a.totalCost}),e.jsx("td",{children:a.balance})]},a.id))})]})}),e.jsx(R,{open:!!s,onClose:g,title:"Edit User",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:g,children:"Cancel"}),e.jsx("button",{className:"btn teal",onClick:H,children:"Save"})]}),children:s&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:s.name||"",onChange:a=>r({...s,name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:s.email||"",onChange:a=>r({...s,email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:s.role||"user",onChange:a=>r({...s,role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:s.balance||0,onChange:a=>r({...s,balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Phone"}),e.jsx("input",{className:"input",value:s.phone||"",onChange:a=>r({...s,phone:a.target.value})}),e.jsx("label",{className:"label",children:"Photo URL"}),e.jsx("input",{className:"input",value:s.photoUrl||"",onChange:a=>r({...s,photoUrl:a.target.value})})]})}),e.jsx(R,{open:!!i,onClose:Q,title:i?`Meals: ${i.name}`:"Meals",children:i&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:b,onChange:async a=>{P(a.target.value),await w(i._id||i.id,a.target.value)}}),e.jsx("div",{className:"scroll-x",children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:T.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:l=>E(i._id||i.id,a.date,"breakfast",l.target.checked)})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:l=>E(i._id||i.id,a.date,"dinner",l.target.checked)})})]},a._id||a.date))})]})})]})})]})}export{he as default};
