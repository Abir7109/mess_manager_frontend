import{u as F,r as h,E as r,j as e}from"./index-B2qj3ula.js";import{d as f,M as R}from"./Modal-D4CdfBbL.js";import{v as W}from"./vite-DjK7I6n3.js";function V(){const{user:A}=F(),N=A?.role==="admin",[d,C]=h.useState(f().format("YYYY-MM")),[M,w]=h.useState([]),[k,I]=h.useState(!1),[y,v]=h.useState(""),[j,S]=h.useState(null),[s,p]=h.useState(null),B=W,[o,g]=h.useState(null),[l,U]=h.useState(f().format("YYYY-MM")),[E,c]=h.useState([]),L=(r.defaults?.baseURL||"").replace(/\/api$/,""),Y=a=>a?/^https?:\/\//i.test(a)?a:L+(a.startsWith("/")?a:"/"+a):B;async function D(){I(!0),v("");try{const{data:a}=await r.get("/public/users",{params:{month:d}});w(a.users||[])}catch(a){if(a?.response?.status===404)try{const{data:t}=await r.get("/admin/overview",{params:{month:d}});w((t.users||[]).map(n=>({id:n.id||n._id,name:n.name,email:n.email,phone:n.phone,photoUrl:n.photoUrl,balance:n.balance,totalMeals:n.totalMeals,totalCost:n.totalCost})))}catch(t){v(t?.response?.data?.error||"Failed to load users")}else v(a?.response?.data?.error||"Failed to load users")}finally{I(!1)}}h.useEffect(()=>{D()},[d]);function m(a,t=[]){const n=f(a+"-01"),i=n.endOf("month"),x=new Map((t||[]).map(u=>[u.date,u])),T=[];for(let u=n;u.isBefore(i)||u.isSame(i,"day");u=u.add(1,"day")){const b=u.format("YYYY-MM-DD");T.push({date:b,breakfast:!!x.get(b)?.breakfast,dinner:!!x.get(b)?.dinner,overrideCount:x.get(b)?.overrideCount})}return T}async function z(a){S(a),U(d),p({month:d,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:a.totalMeals||0,totalCost:a.totalCost||0,mealCost:0,logs:[]});try{const{data:t}=await r.get(`/public/users/${a.id}`,{params:{month:d}});p(t)}catch(t){if(t?.response?.status===404)try{const{data:n}=await r.get("/admin/overview",{params:{month:d}}),i=(n.users||[]).find(x=>(x.id||x._id)===a.id);i&&p({month:d,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:i.totalMeals||0,totalCost:i.totalCost||0,mealCost:n.settings?.mealCost||0,logs:[]})}catch{}}if(N){c(m(d,[]));try{const t=await r.get("/admin/meals",{params:{userId:a.id,month:d}});c(m(d,t.data.logs||[]))}catch{}}}function $(){S(null),p(null)}return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{style:{marginTop:0},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.5 6.5 0 0 1 20 19v.5h4V17c0-2.33-4.67-4-8-4z"})})," Users"]})}),e.jsx("p",{style:{opacity:.8,marginTop:4},children:"Public directory of members and their monthly meal stats."}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:d,onChange:a=>C(a.target.value)})]}),e.jsxs("div",{className:"grid cols-3",style:{marginTop:16},children:[k&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"Loading…"})}),y&&e.jsx("div",{className:"card",style:{color:"crimson"},children:y}),!k&&!y&&M.length===0&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"No users yet."})}),M.map(a=>e.jsxs("div",{className:"card",style:{cursor:"pointer"},onClick:()=>z(a),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("img",{src:Y(a.photoUrl),alt:"",style:{width:48,height:48,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:800},children:a.name}),e.jsx("div",{style:{opacity:.8,fontSize:12},children:a.email})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",a.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(a.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",a.balance]})]})]},a.id))]}),e.jsxs(R,{open:!!j,onClose:$,title:j?j.name:"User",children:[!s&&e.jsx("p",{children:"Loading…"}),s&&s.error&&e.jsx("p",{style:{color:"crimson"},children:s.error}),s&&!s.error&&e.jsxs("div",{className:"grid",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[e.jsx("img",{src:Y(s.user.photoUrl),style:{width:60,height:60,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:900},children:s.user.name}),e.jsxs("div",{style:{opacity:.8,fontSize:12},children:[s.user.email," • ",s.user.phone||"-"]})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",s.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(s.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",s.user.balance]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:d,onChange:async a=>{C(a.target.value);const{data:t}=await r.get(`/public/users/${s.user.id||j.id}`,{params:{month:a.target.value}});p(t)}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:s.logs.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:a.breakfast?"✓":"—"}),e.jsx("td",{children:a.dinner?"✓":"—"})]},a._id||a.date))})]})})]}),N&&e.jsxs("div",{className:"card",children:[e.jsx("h4",{style:{marginTop:0},children:"Admin actions"}),e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:o?.name??s.user.name,onChange:a=>g({...o||{},name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:o?.email??s.user.email,onChange:a=>g({...o||{},email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:o?.role??"user",onChange:a=>g({...o||{},role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:o?.balance??s.user.balance,onChange:a=>g({...o||{},balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Upload Photo"}),e.jsx("input",{type:"file",accept:"image/*",onChange:async a=>{const t=a.target.files?.[0];if(!t)return;const n=new FormData;n.append("photo",t),await r.post(`/admin/users/${s.user.id}/photo`,n,{headers:{"Content-Type":"multipart/form-data"}});const{data:i}=await r.get(`/public/users/${s.user.id}`,{params:{month:d}}).catch(()=>({data:null}));i&&p(i)}}),e.jsx("div",{children:e.jsx("button",{className:"btn teal",onClick:async()=>{const a={name:o?.name??s.user.name,email:o?.email??s.user.email,role:o?.role??"user",balance:o?.balance??s.user.balance};await r.patch(`/admin/users/${s.user.id}`,a),g(null),await D()},children:"Save"})})]}),e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("h4",{style:{marginTop:0},children:"Meals editor"}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:l,onChange:async a=>{const t=a.target.value,n=s?.user?.id||j?.id;U(t),c(m(t,[]));try{const i=await r.get("/admin/meals",{params:{userId:n,month:t}});c(m(t,i.data.logs||[]))}catch{}}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"}),e.jsx("th",{children:"Override (meals)"}),e.jsx("th",{children:"Adjust"})]})}),e.jsx("tbody",{children:E.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:async t=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,breakfast:t.target.checked,dinner:a.dinner});const n=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,n.data.logs||[]))}})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:async t=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,dinner:t.target.checked,breakfast:a.breakfast});const n=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,n.data.logs||[]))}})}),e.jsx("td",{children:e.jsx("input",{className:"input",style:{maxWidth:100},type:"number",step:"0.01",placeholder:"auto",value:a.overrideCount??"",onChange:async t=>{const n=t.target.value;await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:n===""?"":Number(n)});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,i.data.logs||[]))}})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn",onClick:async()=>{const t=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),n=Math.max(0,Math.round((t-1)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:n});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,i.data.logs||[]))},children:"-1"}),e.jsx("button",{className:"btn",onClick:async()=>{const t=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),n=Math.max(0,Math.round((t-.5)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:n});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,i.data.logs||[]))},children:"-0.5"}),e.jsx("button",{className:"btn",onClick:async()=>{const t=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),n=Math.max(0,Math.round((t+.5)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:n});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,i.data.logs||[]))},children:"+0.5"}),e.jsx("button",{className:"btn",onClick:async()=>{const t=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),n=Math.max(0,Math.round((t+1)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:n});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,i.data.logs||[]))},children:"+1"}),e.jsx("button",{className:"btn",onClick:async()=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:""});const t=await r.get("/admin/meals",{params:{userId:s.user.id,month:l}});c(m(l,t.data.logs||[]))},children:"Clear"})]})})]},a._id||a.date))})]})})]})]})]})]})]})}export{V as default};
