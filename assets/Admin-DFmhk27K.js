import{r as t,j as e,F as V,E as o,I as X,J as Z}from"./index-CqIeHo9J.js";import{d as _,M as R}from"./Modal-DJHnm3rO.js";import{B as A,D as ee,C as ae,e as se,b as le,c as te,p as ne,d as ie,A as ce}from"./index-DGAglcAs.js";ae.register(se,le,te,ne,ie,ce);function ue(){const[r,D]=t.useState(_().format("YYYY-MM")),[m,L]=t.useState([]),[de,Y]=t.useState([]),[s,d]=t.useState(null),[n,P]=t.useState(null),[b,T]=t.useState(_().format("YYYY-MM")),[F,v]=t.useState([]),[N,y]=t.useState(""),[C,M]=t.useState("bothEqualsOne"),[u,$]=t.useState(""),[x,O]=t.useState("spent"),[p,I]=t.useState(10);async function f(){const{data:a}=await o.get("/admin/overview",{params:{month:r}});L(a.users),y(a.settings.mealCost),M(a.settings.countingRule)}t.useEffect(()=>{f()},[r]);async function q(){await o.patch("/admin/settings",{mealCost:Number(N),countingRule:C}),f()}async function S(){const{data:a}=await o.get("/admin/users");Y(a)}t.useEffect(()=>{S()},[]);function j(){d(null)}async function H(){await o.patch(`/admin/users/${s._id||s.id}`,{name:s.name,email:s.email,role:s.role,balance:s.balance,phone:s.phone,photoUrl:s.photoUrl}),j(),S()}function J(){P(null),v([])}async function k(a,l){const{data:i}=await o.get("/admin/meals",{params:{userId:a,month:l}});v(i.logs||[])}async function w(a,l,i,g){await o.post("/admin/meals/upsert",{userId:a,date:l,[i]:g}),await k(a,b)}function Q(){const a=X(),l=a?`&access_token=${encodeURIComponent(a)}`:"",i=Z(`/api/admin/pdf?month=${r}${l}`);window.open(i,"_blank")}const c=t.useMemo(()=>{const a=x,l=m.filter(i=>(i.name+" "+i.email).toLowerCase().includes(u.toLowerCase()));return l.sort((i,g)=>{const B={meals:"totalMeals",spent:"totalCost",balance:"balance"}[a];return(g[B]||0)-(i[B]||0)}),l.slice(0,p)},[m,u,x,p]),h=c.map(a=>a.name),W=c.map(a=>a.totalMeals),E=c.map(a=>Math.round(a.totalCost));c.map(a=>Math.round(a.balance));const U={responsive:!0,plugins:{legend:{display:!0}}},z={labels:h,datasets:[{label:"Meals",data:W,backgroundColor:"#0F766E"}]},G={labels:h,datasets:[{label:"Spent (৳)",data:E,backgroundColor:"#B77466"}]},K={labels:h,datasets:[{data:E,backgroundColor:h.map((a,l)=>`hsl(${l*37%360} 70% 65%)`)}]};return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card glass",children:[e.jsx("h2",{children:"Admin Overview"}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:r,onChange:a=>D(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Meal Cost"}),e.jsx("input",{className:"input",type:"number",value:N,onChange:a=>y(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Counting Rule"}),e.jsxs("select",{className:"input",value:C,onChange:a=>M(a.target.value),children:[e.jsx("option",{value:"bothEqualsOne",children:"Both meals = 1"}),e.jsx("option",{value:"anyMealIsOne",children:"Any meal = 1"}),e.jsx("option",{value:"perMeal",children:"Per meal (1.0 each)"}),e.jsx("option",{value:"perMealHalf",children:"Per meal (0.5 each)"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"end",gap:8},children:[e.jsx("button",{className:"btn",onClick:q,children:"Save"}),e.jsx("button",{className:"btn",onClick:Q,children:"PDF"})]})]})]}),e.jsxs("div",{className:"card glass",style:{marginTop:16},children:[e.jsxs("h3",{style:{marginTop:0},children:[e.jsx(V,{})," Analytics"]}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Search"}),e.jsx("input",{className:"input",placeholder:"name or email",value:u,onChange:a=>$(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Sort By"}),e.jsxs("select",{className:"input",value:x,onChange:a=>O(a.target.value),children:[e.jsx("option",{value:"spent",children:"Spent"}),e.jsx("option",{value:"meals",children:"Meals"}),e.jsx("option",{value:"balance",children:"Balance"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Top N"}),e.jsx("input",{className:"input",type:"number",min:"1",max:"50",value:p,onChange:a=>I(parseInt(a.target.value||"1",10))})]})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:12},children:e.jsxs("div",{className:"grid cols-2",style:{minWidth:640},children:[e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Meals by User"}),c.length?e.jsx(A,{options:U,data:z}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend by User"}),c.length?e.jsx(A,{options:U,data:G}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend Share"}),c.length?e.jsx(ee,{data:K}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Leaderboard"}),e.jsx("ol",{style:{margin:0,paddingLeft:18},children:c.map((a,l)=>e.jsxs("li",{style:{marginBottom:6},children:[a.name," — ৳",Math.round(a.totalCost)," • ",a.totalMeals," meals"]},a.id))})]})]})})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:16},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Meals"}),e.jsx("th",{children:"Meal Cost"}),e.jsx("th",{children:"Spent"}),e.jsx("th",{children:"Balance"})]})}),e.jsx("tbody",{children:m.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.totalMeals}),e.jsx("td",{children:a.mealCost}),e.jsx("td",{children:a.totalCost}),e.jsx("td",{children:a.balance})]},a.id))})]})}),e.jsx(R,{open:!!s,onClose:j,title:"Edit User",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:j,children:"Cancel"}),e.jsx("button",{className:"btn teal",onClick:H,children:"Save"})]}),children:s&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:s.name||"",onChange:a=>d({...s,name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:s.email||"",onChange:a=>d({...s,email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:s.role||"user",onChange:a=>d({...s,role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:s.balance||0,onChange:a=>d({...s,balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Phone"}),e.jsx("input",{className:"input",value:s.phone||"",onChange:a=>d({...s,phone:a.target.value})}),e.jsx("label",{className:"label",children:"Photo URL"}),e.jsx("input",{className:"input",value:s.photoUrl||"",onChange:a=>d({...s,photoUrl:a.target.value})})]})}),e.jsx(R,{open:!!n,onClose:J,title:n?`Meals: ${n.name}`:"Meals",children:n&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:b,onChange:async a=>{T(a.target.value),await k(n._id||n.id,a.target.value)}}),e.jsx("div",{className:"scroll-x",children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:F.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:l=>w(n._id||n.id,a.date,"breakfast",l.target.checked)})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:l=>w(n._id||n.id,a.date,"dinner",l.target.checked)})})]},a._id||a.date))})]})})]})})]})}export{ue as default};
