import{r as l,j as e,F as V,E as r}from"./index-DVSKXtA-.js";import{d as L,M as R}from"./Modal-DpxqM1NZ.js";import{B as _,D as X,C as Z,e as ee,b as ae,c as se,p as te,d as le,A as ne}from"./index-CDQgf74R.js";Z.register(ee,ae,se,te,le,ne);function he(){const[h,D]=l.useState(L().format("YYYY-MM")),[u,F]=l.useState([]),[ie,O]=l.useState([]),[s,o]=l.useState(null),[n,Y]=l.useState(null),[p,P]=l.useState(L().format("YYYY-MM")),[T,N]=l.useState([]),[y,C]=l.useState(""),[M,f]=l.useState("bothEqualsOne"),[x,A]=l.useState(""),[j,$]=l.useState("spent"),[g,q]=l.useState(10);async function S(){const{data:a}=await r.get("/admin/overview",{params:{month:h}});F(a.users),C(a.settings.mealCost),f(a.settings.countingRule)}l.useEffect(()=>{S()},[h]);async function I(){await r.patch("/admin/settings",{mealCost:Number(y),countingRule:M}),S()}async function w(){const{data:a}=await r.get("/admin/users");O(a)}l.useEffect(()=>{w()},[]);function b(){o(null)}async function W(){await r.patch(`/admin/users/${s._id||s.id}`,{name:s.name,email:s.email,role:s.role,balance:s.balance,phone:s.phone,photoUrl:s.photoUrl}),b(),w()}function H(){Y(null),N([])}async function v(a,t){const{data:i}=await r.get("/admin/meals",{params:{userId:a,month:t}});N(i.logs||[])}async function E(a,t,i,c){await r.post("/admin/meals/upsert",{userId:a,date:t,[i]:c}),await v(a,p)}async function Q(){try{const a=await r.get("/admin/pdf",{params:{month:h},responseType:"blob"}),t=new Blob([a.data],{type:"application/pdf"}),i=URL.createObjectURL(t),c=document.createElement("a");c.href=i,c.download=`mess-overview-${h}.pdf`,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(i)}catch(a){alert(a?.response?.data?.error||"Failed to download PDF")}}const d=l.useMemo(()=>{const a=j,t=u.filter(i=>(i.name+" "+i.email).toLowerCase().includes(x.toLowerCase()));return t.sort((i,c)=>{const B={meals:"totalMeals",spent:"totalCost",balance:"balance"}[a];return(c[B]||0)-(i[B]||0)}),t.slice(0,g)},[u,x,j,g]),m=d.map(a=>a.name),z=d.map(a=>a.totalMeals),U=d.map(a=>Math.round(a.totalCost));d.map(a=>Math.round(a.balance));const k={responsive:!0,plugins:{legend:{display:!0}}},G={labels:m,datasets:[{label:"Meals",data:z,backgroundColor:"#0F766E"}]},J={labels:m,datasets:[{label:"Spent (৳)",data:U,backgroundColor:"#B77466"}]},K={labels:m,datasets:[{data:U,backgroundColor:m.map((a,t)=>`hsl(${t*37%360} 70% 65%)`)}]};return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card glass",children:[e.jsx("h2",{children:"Admin Overview"}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:h,onChange:a=>D(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Meal Cost"}),e.jsx("input",{className:"input",type:"number",value:y,onChange:a=>C(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Counting Rule"}),e.jsxs("select",{className:"input",value:M,onChange:a=>f(a.target.value),children:[e.jsx("option",{value:"bothEqualsOne",children:"Both meals = 1"}),e.jsx("option",{value:"anyMealIsOne",children:"Any meal = 1"}),e.jsx("option",{value:"perMeal",children:"Per meal (1.0 each)"}),e.jsx("option",{value:"perMealHalf",children:"Per meal (0.5 each)"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"end",gap:8},children:[e.jsx("button",{className:"btn",onClick:I,children:"Save"}),e.jsx("button",{className:"btn",onClick:Q,children:"PDF"})]})]})]}),e.jsxs("div",{className:"card glass",style:{marginTop:16},children:[e.jsxs("h3",{style:{marginTop:0},children:[e.jsx(V,{})," Analytics"]}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Search"}),e.jsx("input",{className:"input",placeholder:"name or email",value:x,onChange:a=>A(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Sort By"}),e.jsxs("select",{className:"input",value:j,onChange:a=>$(a.target.value),children:[e.jsx("option",{value:"spent",children:"Spent"}),e.jsx("option",{value:"meals",children:"Meals"}),e.jsx("option",{value:"balance",children:"Balance"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Top N"}),e.jsx("input",{className:"input",type:"number",min:"1",max:"50",value:g,onChange:a=>q(parseInt(a.target.value||"1",10))})]})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:12},children:e.jsxs("div",{className:"grid cols-2",style:{minWidth:640},children:[e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Meals by User"}),d.length?e.jsx(_,{options:k,data:G}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend by User"}),d.length?e.jsx(_,{options:k,data:J}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend Share"}),d.length?e.jsx(X,{data:K}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Leaderboard"}),e.jsx("ol",{style:{margin:0,paddingLeft:18},children:d.map((a,t)=>e.jsxs("li",{style:{marginBottom:6},children:[a.name," — ৳",Math.round(a.totalCost)," • ",a.totalMeals," meals"]},a.id))})]})]})})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:16},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Meals"}),e.jsx("th",{children:"Meal Cost"}),e.jsx("th",{children:"Spent"}),e.jsx("th",{children:"Balance"})]})}),e.jsx("tbody",{children:u.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.totalMeals}),e.jsx("td",{children:a.mealCost}),e.jsx("td",{children:a.totalCost}),e.jsx("td",{children:a.balance})]},a.id))})]})}),e.jsx(R,{open:!!s,onClose:b,title:"Edit User",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:b,children:"Cancel"}),e.jsx("button",{className:"btn teal",onClick:W,children:"Save"})]}),children:s&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:s.name||"",onChange:a=>o({...s,name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:s.email||"",onChange:a=>o({...s,email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:s.role||"user",onChange:a=>o({...s,role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:s.balance||0,onChange:a=>o({...s,balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Phone"}),e.jsx("input",{className:"input",value:s.phone||"",onChange:a=>o({...s,phone:a.target.value})}),e.jsx("label",{className:"label",children:"Photo URL"}),e.jsx("input",{className:"input",value:s.photoUrl||"",onChange:a=>o({...s,photoUrl:a.target.value})})]})}),e.jsx(R,{open:!!n,onClose:H,title:n?`Meals: ${n.name}`:"Meals",children:n&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:p,onChange:async a=>{P(a.target.value),await v(n._id||n.id,a.target.value)}}),e.jsx("div",{className:"scroll-x",children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"}),e.jsx("th",{children:"Override (meals)"})]})}),e.jsx("tbody",{children:T.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:t=>E(n._id||n.id,a.date,"breakfast",t.target.checked)})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:t=>E(n._id||n.id,a.date,"dinner",t.target.checked)})}),e.jsx("td",{children:e.jsx("input",{className:"input",style:{maxWidth:100},type:"number",step:"0.01",placeholder:"auto",value:a.overrideCount??"",onChange:async t=>{const i=t.target.value;await r.post("/admin/meals/upsert",{userId:n._id||n.id,date:a.date,overrideCount:i===""?"":Number(i)}),await v(n._id||n.id,p)}})})]},a._id||a.date))})]})})]})})]})}export{he as default};
