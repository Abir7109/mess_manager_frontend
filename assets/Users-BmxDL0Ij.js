import{u as Y,r as o,E as r,j as e}from"./index-CDIynnyR.js";import{d as k,M as B}from"./Modal-BMm08Dy5.js";import{v as z}from"./vite-DjK7I6n3.js";function W(){const{user:I}=Y(),S=I?.role==="admin",[d,g]=o.useState(k().format("YYYY-MM")),[b,v]=o.useState([]),[y,f]=o.useState(!1),[x,j]=o.useState(""),[p,N]=o.useState(null),[s,h]=o.useState(null),U=z,[l,u]=o.useState(null),[c,T]=o.useState(k().format("YYYY-MM")),[A,m]=o.useState([]),D=(r.defaults?.baseURL||"").replace(/\/api$/,""),C=a=>a?/^https?:\/\//i.test(a)?a:D+(a.startsWith("/")?a:"/"+a):U;async function M(){f(!0),j("");try{const{data:a}=await r.get("/public/users",{params:{month:d}});v(a.users||[])}catch(a){if(a?.response?.status===404)try{const{data:n}=await r.get("/admin/overview",{params:{month:d}});v((n.users||[]).map(t=>({id:t.id||t._id,name:t.name,email:t.email,phone:t.phone,photoUrl:t.photoUrl,balance:t.balance,totalMeals:t.totalMeals,totalCost:t.totalCost})))}catch(n){j(n?.response?.data?.error||"Failed to load users")}else j(a?.response?.data?.error||"Failed to load users")}finally{f(!1)}}o.useEffect(()=>{M()},[d]);async function E(a){N(a),h({month:d,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:a.totalMeals||0,totalCost:a.totalCost||0,mealCost:0,logs:[]});try{const{data:n}=await r.get(`/public/users/${a.id}`,{params:{month:d}});h(n)}catch(n){if(n?.response?.status===404)try{const{data:t}=await r.get("/admin/overview",{params:{month:d}}),i=(t.users||[]).find(w=>(w.id||w._id)===a.id);i&&h({month:d,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:i.totalMeals||0,totalCost:i.totalCost||0,mealCost:t.settings?.mealCost||0,logs:[]})}catch{}}}function L(){N(null),h(null)}return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{style:{marginTop:0},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.5 6.5 0 0 1 20 19v.5h4V17c0-2.33-4.67-4-8-4z"})})," Users"]})}),e.jsx("p",{style:{opacity:.8,marginTop:4},children:"Public directory of members and their monthly meal stats."}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:d,onChange:a=>g(a.target.value)})]}),e.jsxs("div",{className:"grid cols-3",style:{marginTop:16},children:[y&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"Loading…"})}),x&&e.jsx("div",{className:"card",style:{color:"crimson"},children:x}),!y&&!x&&b.length===0&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"No users yet."})}),b.map(a=>e.jsxs("div",{className:"card",style:{cursor:"pointer"},onClick:()=>E(a),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("img",{src:C(a.photoUrl),alt:"",style:{width:48,height:48,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:800},children:a.name}),e.jsx("div",{style:{opacity:.8,fontSize:12},children:a.email})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",a.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(a.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",a.balance]})]})]},a.id))]}),e.jsxs(B,{open:!!p,onClose:L,title:p?p.name:"User",children:[!s&&e.jsx("p",{children:"Loading…"}),s&&s.error&&e.jsx("p",{style:{color:"crimson"},children:s.error}),s&&!s.error&&e.jsxs("div",{className:"grid",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[e.jsx("img",{src:C(s.user.photoUrl),style:{width:60,height:60,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:900},children:s.user.name}),e.jsxs("div",{style:{opacity:.8,fontSize:12},children:[s.user.email," • ",s.user.phone||"-"]})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",s.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(s.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",s.user.balance]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:d,onChange:async a=>{g(a.target.value);const{data:n}=await r.get(`/public/users/${s.user.id||p.id}`,{params:{month:a.target.value}});h(n)}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:s.logs.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:a.breakfast?"✓":"—"}),e.jsx("td",{children:a.dinner?"✓":"—"})]},a._id||a.date))})]})})]}),S&&e.jsxs("div",{className:"card",children:[e.jsx("h4",{style:{marginTop:0},children:"Admin actions"}),e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:l?.name??s.user.name,onChange:a=>u({...l||{},name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:l?.email??s.user.email,onChange:a=>u({...l||{},email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:l?.role??"user",onChange:a=>u({...l||{},role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:l?.balance??s.user.balance,onChange:a=>u({...l||{},balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Upload Photo"}),e.jsx("input",{type:"file",accept:"image/*",onChange:async a=>{const n=a.target.files?.[0];if(!n)return;const t=new FormData;t.append("photo",n),await r.post(`/admin/users/${s.user.id}/photo`,t,{headers:{"Content-Type":"multipart/form-data"}});const{data:i}=await r.get(`/public/users/${s.user.id}`,{params:{month:d}}).catch(()=>({data:null}));i&&h(i)}}),e.jsx("div",{children:e.jsx("button",{className:"btn teal",onClick:async()=>{const a={name:l?.name??s.user.name,email:l?.email??s.user.email,role:l?.role??"user",balance:l?.balance??s.user.balance};await r.patch(`/admin/users/${s.user.id}`,a),u(null),await M()},children:"Save"})})]}),e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("h4",{style:{marginTop:0},children:"Meals editor"}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:c,onChange:async a=>{T(a.target.value);const n=await r.get("/admin/meals",{params:{userId:s.user.id,month:a.target.value}});m(n.data.logs||[])}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"}),e.jsx("th",{children:"Override (meals)"}),e.jsx("th",{children:"Adjust"})]})}),e.jsx("tbody",{children:A.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:async n=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,breakfast:n.target.checked,dinner:a.dinner});const t=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(t.data.logs||[])}})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:async n=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,dinner:n.target.checked,breakfast:a.breakfast});const t=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(t.data.logs||[])}})}),e.jsx("td",{children:e.jsx("input",{className:"input",style:{maxWidth:100},type:"number",step:"0.01",placeholder:"auto",value:a.overrideCount??"",onChange:async n=>{const t=n.target.value;await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:t===""?"":Number(t)});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(i.data.logs||[])}})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn",onClick:async()=>{const n=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),t=Math.max(0,Math.round((n-1)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:t});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(i.data.logs||[])},children:"-1"}),e.jsx("button",{className:"btn",onClick:async()=>{const n=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),t=Math.max(0,Math.round((n-.5)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:t});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(i.data.logs||[])},children:"-0.5"}),e.jsx("button",{className:"btn",onClick:async()=>{const n=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),t=Math.max(0,Math.round((n+.5)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:t});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(i.data.logs||[])},children:"+0.5"}),e.jsx("button",{className:"btn",onClick:async()=>{const n=typeof a.overrideCount=="number"?Number(a.overrideCount):(a.breakfast?.5:0)+(a.dinner?.5:0),t=Math.max(0,Math.round((n+1)*100)/100);await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:t});const i=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(i.data.logs||[])},children:"+1"}),e.jsx("button",{className:"btn",onClick:async()=>{await r.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,overrideCount:""});const n=await r.get("/admin/meals",{params:{userId:s.user.id,month:c}});m(n.data.logs||[])},children:"Clear"})]})})]},a._id||a.date))})]})})]})]})]})]})]})}export{W as default};
