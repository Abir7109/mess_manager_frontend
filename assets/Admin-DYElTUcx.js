import{r as l,j as e,F as V,E as d}from"./index-_VO9UuRc.js";import{d as L}from"./dayjs.min-BJVi2QZU.js";import{B as _,D as X,C as Z,a as ee,b as ae,L as se,p as le,c as te,A as ne}from"./index-CqVGB3J3.js";import{M as D}from"./Modal-BzwjeD4G.js";Z.register(ee,ae,se,le,te,ne);function me(){const[o,R]=l.useState(L().format("YYYY-MM")),[m,Y]=l.useState([]),[ie,A]=l.useState([]),[s,r]=l.useState(null),[n,F]=l.useState(null),[b,P]=l.useState(L().format("YYYY-MM")),[T,v]=l.useState([]),[N,y]=l.useState(""),[C,M]=l.useState("bothEqualsOne"),[u,O]=l.useState(""),[x,$]=l.useState("spent"),[p,q]=l.useState(10);async function f(){const{data:a}=await d.get("/admin/overview",{params:{month:o}});Y(a.users),y(a.settings.mealCost),M(a.settings.countingRule)}l.useEffect(()=>{f()},[o]);async function I(){await d.patch("/admin/settings",{mealCost:Number(N),countingRule:C}),f()}async function S(){const{data:a}=await d.get("/admin/users");A(a)}l.useEffect(()=>{S()},[]);function j(){r(null)}async function H(){await d.patch(`/admin/users/${s._id||s.id}`,{name:s.name,email:s.email,role:s.role,balance:s.balance,phone:s.phone,photoUrl:s.photoUrl}),j(),S()}function Q(){F(null),v([])}async function w(a,t){const{data:c}=await d.get("/admin/meals",{params:{userId:a,month:t}});v(c.logs||[])}async function E(a,t,c,g){await d.post("/admin/meals/upsert",{userId:a,date:t,[c]:g}),await w(a,b)}function W(){const a=`/api/admin/pdf?month=${o}`;window.open(a,"_blank")}const i=l.useMemo(()=>{const a=x,t=m.filter(c=>(c.name+" "+c.email).toLowerCase().includes(u.toLowerCase()));return t.sort((c,g)=>{const B={meals:"totalMeals",spent:"totalCost",balance:"balance"}[a];return(g[B]||0)-(c[B]||0)}),t.slice(0,p)},[m,u,x,p]),h=i.map(a=>a.name),z=i.map(a=>a.totalMeals),k=i.map(a=>Math.round(a.totalCost));i.map(a=>Math.round(a.balance));const U={responsive:!0,plugins:{legend:{display:!0}}},G={labels:h,datasets:[{label:"Meals",data:z,backgroundColor:"#0F766E"}]},J={labels:h,datasets:[{label:"Spent (৳)",data:k,backgroundColor:"#B77466"}]},K={labels:h,datasets:[{data:k,backgroundColor:h.map((a,t)=>`hsl(${t*37%360} 70% 65%)`)}]};return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card glass",children:[e.jsx("h2",{children:"Admin Overview"}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:o,onChange:a=>R(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Meal Cost"}),e.jsx("input",{className:"input",type:"number",value:N,onChange:a=>y(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Counting Rule"}),e.jsxs("select",{className:"input",value:C,onChange:a=>M(a.target.value),children:[e.jsx("option",{value:"bothEqualsOne",children:"Both meals = 1"}),e.jsx("option",{value:"anyMealIsOne",children:"Any meal = 1"}),e.jsx("option",{value:"perMeal",children:"Per meal (1.0 each)"}),e.jsx("option",{value:"perMealHalf",children:"Per meal (0.5 each)"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"end",gap:8},children:[e.jsx("button",{className:"btn",onClick:I,children:"Save"}),e.jsx("button",{className:"btn",onClick:W,children:"PDF"})]})]})]}),e.jsxs("div",{className:"card glass",style:{marginTop:16},children:[e.jsxs("h3",{style:{marginTop:0},children:[e.jsx(V,{})," Analytics"]}),e.jsxs("div",{className:"grid cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Search"}),e.jsx("input",{className:"input",placeholder:"name or email",value:u,onChange:a=>O(a.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Sort By"}),e.jsxs("select",{className:"input",value:x,onChange:a=>$(a.target.value),children:[e.jsx("option",{value:"spent",children:"Spent"}),e.jsx("option",{value:"meals",children:"Meals"}),e.jsx("option",{value:"balance",children:"Balance"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Top N"}),e.jsx("input",{className:"input",type:"number",min:"1",max:"50",value:p,onChange:a=>q(parseInt(a.target.value||"1",10))})]})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:12},children:e.jsxs("div",{className:"grid cols-2",style:{minWidth:640},children:[e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Meals by User"}),i.length?e.jsx(_,{options:U,data:G}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend by User"}),i.length?e.jsx(_,{options:U,data:J}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Spend Share"}),i.length?e.jsx(X,{data:K}):e.jsx("em",{children:"No data"})]}),e.jsxs("div",{className:"card",style:{padding:12},children:[e.jsx("h4",{style:{margin:"6px 0"},children:"Leaderboard"}),e.jsx("ol",{style:{margin:0,paddingLeft:18},children:i.map((a,t)=>e.jsxs("li",{style:{marginBottom:6},children:[a.name," — ৳",Math.round(a.totalCost)," • ",a.totalMeals," meals"]},a.id))})]})]})})]}),e.jsx("div",{className:"scroll-x",style:{marginTop:16},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Meals"}),e.jsx("th",{children:"Meal Cost"}),e.jsx("th",{children:"Spent"}),e.jsx("th",{children:"Balance"})]})}),e.jsx("tbody",{children:m.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.name}),e.jsx("td",{children:a.email}),e.jsx("td",{children:a.totalMeals}),e.jsx("td",{children:a.mealCost}),e.jsx("td",{children:a.totalCost}),e.jsx("td",{children:a.balance})]},a.id))})]})}),e.jsx(D,{open:!!s,onClose:j,title:"Edit User",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn",onClick:j,children:"Cancel"}),e.jsx("button",{className:"btn teal",onClick:H,children:"Save"})]}),children:s&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:s.name||"",onChange:a=>r({...s,name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:s.email||"",onChange:a=>r({...s,email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:s.role||"user",onChange:a=>r({...s,role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:s.balance||0,onChange:a=>r({...s,balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Phone"}),e.jsx("input",{className:"input",value:s.phone||"",onChange:a=>r({...s,phone:a.target.value})}),e.jsx("label",{className:"label",children:"Photo URL"}),e.jsx("input",{className:"input",value:s.photoUrl||"",onChange:a=>r({...s,photoUrl:a.target.value})})]})}),e.jsx(D,{open:!!n,onClose:Q,title:n?`Meals: ${n.name}`:"Meals",children:n&&e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:b,onChange:async a=>{P(a.target.value),await w(n._id||n.id,a.target.value)}}),e.jsx("div",{className:"scroll-x",children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:T.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:t=>E(n._id||n.id,a.date,"breakfast",t.target.checked)})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:t=>E(n._id||n.id,a.date,"dinner",t.target.checked)})})]},a._id||a.date))})]})})]})})]})}export{me as default};
