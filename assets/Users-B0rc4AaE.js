import{u as A,r as d,E as n,j as e}from"./index-BNDnUIvJ.js";import{d as S,M as B}from"./Modal-Bie7F7VV.js";import{v as z}from"./vite-DjK7I6n3.js";function _(){const{user:k}=A(),U=k?.role==="admin",[r,g]=d.useState(S().format("YYYY-MM")),[b,y]=d.useState([]),[v,f]=d.useState(!1),[p,x]=d.useState(""),[m,N]=d.useState(null),[s,c]=d.useState(null),T=z,[i,h]=d.useState(null),[u,D]=d.useState(S().format("YYYY-MM")),[E,j]=d.useState([]),I=(n.defaults?.baseURL||"").replace(/\/api$/,""),M=a=>a?/^https?:\/\//i.test(a)?a:I+(a.startsWith("/")?a:"/"+a):T;async function C(){f(!0),x("");try{const{data:a}=await n.get("/public/users",{params:{month:r}});y(a.users||[])}catch(a){if(a?.response?.status===404)try{const{data:l}=await n.get("/admin/overview",{params:{month:r}});y((l.users||[]).map(t=>({id:t.id||t._id,name:t.name,email:t.email,phone:t.phone,photoUrl:t.photoUrl,balance:t.balance,totalMeals:t.totalMeals,totalCost:t.totalCost})))}catch(l){x(l?.response?.data?.error||"Failed to load users")}else x(a?.response?.data?.error||"Failed to load users")}finally{f(!1)}}d.useEffect(()=>{C()},[r]);async function L(a){N(a),c({month:r,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:a.totalMeals||0,totalCost:a.totalCost||0,mealCost:0,logs:[]});try{const{data:l}=await n.get(`/public/users/${a.id}`,{params:{month:r}});c(l)}catch(l){if(l?.response?.status===404)try{const{data:t}=await n.get("/admin/overview",{params:{month:r}}),o=(t.users||[]).find(w=>(w.id||w._id)===a.id);o&&c({month:r,user:{id:a.id,name:a.name,email:a.email,phone:a.phone,photoUrl:a.photoUrl,balance:a.balance},totalMeals:o.totalMeals||0,totalCost:o.totalCost||0,mealCost:t.settings?.mealCost||0,logs:[]})}catch{}}}function Y(){N(null),c(null)}return e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"card",children:[e.jsx("h2",{style:{marginTop:0},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.5 6.5 0 0 1 20 19v.5h4V17c0-2.33-4.67-4-8-4z"})})," Users"]})}),e.jsx("p",{style:{opacity:.8,marginTop:4},children:"Public directory of members and their monthly meal stats."}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:r,onChange:a=>g(a.target.value)})]}),e.jsxs("div",{className:"grid cols-3",style:{marginTop:16},children:[v&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"Loading…"})}),p&&e.jsx("div",{className:"card",style:{color:"crimson"},children:p}),!v&&!p&&b.length===0&&e.jsx("div",{className:"card",children:e.jsx("p",{children:"No users yet."})}),b.map(a=>e.jsxs("div",{className:"card",style:{cursor:"pointer"},onClick:()=>L(a),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsx("img",{src:M(a.photoUrl),alt:"",style:{width:48,height:48,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:800},children:a.name}),e.jsx("div",{style:{opacity:.8,fontSize:12},children:a.email})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",a.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(a.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",a.balance]})]})]},a.id))]}),e.jsxs(B,{open:!!m,onClose:Y,title:m?m.name:"User",children:[!s&&e.jsx("p",{children:"Loading…"}),s&&s.error&&e.jsx("p",{style:{color:"crimson"},children:s.error}),s&&!s.error&&e.jsxs("div",{className:"grid",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[e.jsx("img",{src:M(s.user.photoUrl),style:{width:60,height:60,borderRadius:12,objectFit:"cover"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:900},children:s.user.name}),e.jsxs("div",{style:{opacity:.8,fontSize:12},children:[s.user.email," • ",s.user.phone||"-"]})]})]}),e.jsxs("p",{style:{marginTop:8},children:[e.jsxs("span",{className:"badge",children:["Meals: ",s.totalMeals]}),e.jsxs("span",{className:"badge",children:["Spent: ",Math.round(s.totalCost)]}),e.jsxs("span",{className:"badge",children:["Balance: ",s.user.balance]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:r,onChange:async a=>{g(a.target.value);const{data:l}=await n.get(`/public/users/${s.user.id||m.id}`,{params:{month:a.target.value}});c(l)}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:s.logs.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:a.breakfast?"✓":"—"}),e.jsx("td",{children:a.dinner?"✓":"—"})]},a._id||a.date))})]})})]}),U&&e.jsxs("div",{className:"card",children:[e.jsx("h4",{style:{marginTop:0},children:"Admin actions"}),e.jsxs("div",{className:"grid",children:[e.jsx("label",{className:"label",children:"Name"}),e.jsx("input",{className:"input",value:i?.name??s.user.name,onChange:a=>h({...i||{},name:a.target.value})}),e.jsx("label",{className:"label",children:"Email"}),e.jsx("input",{className:"input",value:i?.email??s.user.email,onChange:a=>h({...i||{},email:a.target.value})}),e.jsx("label",{className:"label",children:"Role"}),e.jsxs("select",{className:"input",value:i?.role??"user",onChange:a=>h({...i||{},role:a.target.value}),children:[e.jsx("option",{value:"user",children:"user"}),e.jsx("option",{value:"admin",children:"admin"})]}),e.jsx("label",{className:"label",children:"Balance"}),e.jsx("input",{className:"input",type:"number",value:i?.balance??s.user.balance,onChange:a=>h({...i||{},balance:Number(a.target.value)})}),e.jsx("label",{className:"label",children:"Upload Photo"}),e.jsx("input",{type:"file",accept:"image/*",onChange:async a=>{const l=a.target.files?.[0];if(!l)return;const t=new FormData;t.append("photo",l),await n.post(`/admin/users/${s.user.id}/photo`,t,{headers:{"Content-Type":"multipart/form-data"}});const{data:o}=await n.get(`/public/users/${s.user.id}`,{params:{month:r}}).catch(()=>({data:null}));o&&c(o)}}),e.jsx("div",{children:e.jsx("button",{className:"btn teal",onClick:async()=>{const a={name:i?.name??s.user.name,email:i?.email??s.user.email,role:i?.role??"user",balance:i?.balance??s.user.balance};await n.patch(`/admin/users/${s.user.id}`,a),h(null),await C()},children:"Save"})})]}),e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("h4",{style:{marginTop:0},children:"Meals editor"}),e.jsx("label",{className:"label",children:"Month"}),e.jsx("input",{className:"input",type:"month",value:u,onChange:async a=>{D(a.target.value);const l=await n.get("/admin/meals",{params:{userId:s.user.id,month:a.target.value}});j(l.data.logs||[])}}),e.jsx("div",{className:"scroll-x",style:{marginTop:8},children:e.jsxs("table",{className:"table wide",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Breakfast"}),e.jsx("th",{children:"Dinner"})]})}),e.jsx("tbody",{children:E.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.date}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.breakfast,onChange:async l=>{await n.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,breakfast:l.target.checked,dinner:a.dinner});const t=await n.get("/admin/meals",{params:{userId:s.user.id,month:u}});j(t.data.logs||[])}})}),e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:!!a.dinner,onChange:async l=>{await n.post("/admin/meals/upsert",{userId:s.user.id,date:a.date,dinner:l.target.checked,breakfast:a.breakfast});const t=await n.get("/admin/meals",{params:{userId:s.user.id,month:u}});j(t.data.logs||[])}})})]},a._id||a.date))})]})})]})]})]})]})]})}export{_ as default};
